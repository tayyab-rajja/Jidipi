import { changePostsData } from "helpers/changePostsData";
import { GetServerSideProps } from "next";
import { serverSideTranslations } from "next-i18next/serverSideTranslations";
import Head from "next/head";
import Link from "next/link";
import { useRouter } from "next/router";
import React from "react";
import { fetchPageFolders } from "src/api/fetchPageFolders";
import Card from "src/components/Card";
import Layout from "src/components/Layout";
import Sidebar from "src/components/Sidebar";
import { PageFolders } from "types/pageFoldersTypes";
import { Post } from "types/postTypes";

interface Props {
  pageFolders: PageFolders[];
  posts: {
    posts: [] | Post[];
    total: number;
  };
  sidebarCategories: any;
}

const FolderPage = ({ pageFolders, posts, sidebarCategories }: Props) => {
  const postsData: Post[] = posts?.posts ?? [];
  const { query } = useRouter();

  return (
    <div>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Layout
        SidebarComponent={<Sidebar sidebarCategories={sidebarCategories} />}
        pageFolders={pageFolders}
      >
        {postsData.map(({ title, categories, image, id, slug }) => (
          <div key={id} style={{ width: 450, margin: "0 20px 20px 0" }}>
            <Card
              id={id}
              folder={query.folder as string}
              slug={slug}
              title={title}
              categories={categories}
              image={image}
            />
          </div>
        ))}
      </Layout>
    </div>
  );
};

export default FolderPage;

export const getServerSideProps: GetServerSideProps = async ({
  params,
  locale,
}) => {
  let pageFolders: PageFolders[] = [];
  let posts = {};
  let sidebarCategories = [];

  try {
    pageFolders = await fetchPageFolders();
  } catch (e) {
    console.log(e);
  }

  const currentPageFolder = pageFolders.find(
    (pageFolder) => pageFolder.subDomain === params?.folder
  );

  try {
    const responseSidebarCategories = await fetch(
      `${process.env.NEXT_PUBLIC_API_URL}/category?pageFolderId=${currentPageFolder?._id}`
    );

    const responsePosts = await fetch(
      `${process.env.NEXT_PUBLIC_API_URL}/post/public/${currentPageFolder?._id}?pageNumber=0&pageSize=10&language=EN`
    );

    const postsFromApi = await responsePosts.json();
    const sidebarCategoriesFromApi = await responseSidebarCategories.json();

    posts = {
      posts: changePostsData(postsFromApi.posts),
    };
    sidebarCategories = sidebarCategoriesFromApi;
  } catch (e) {
    console.log(e);
  }

  return {
    notFound: !currentPageFolder,
    props: {
      ...(await serverSideTranslations(locale as string, ["common"])),
      posts,
      sidebarCategories,
      pageFolders,
    },
  };
};

// TODO: check qs
const getPosts = async (folderId: string, qs: string) => {
  if (!folderId) {
    // TO DO: Check is folderId is null
  }

  const responsePosts = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/post/public/${folderId}?${qs}`
  );

  const postsFromApi = await responsePosts.json();

  return postsFromApi;
};
